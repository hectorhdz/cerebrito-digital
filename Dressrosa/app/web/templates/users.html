{% extends "base.html" %}

{% block content %}
<section class="card">
  <h1>User Management</h1>
  <p>Signed in as <strong>{{ current_user.full_name }}</strong></p>

  {% if error %}
  <p style="color:#a12d2f;">{{ error }}</p>
  {% endif %}

  <h2>Create User</h2>
  <form method="post" action="/users">
    <label for="username">Username</label><br />
    <input id="username" name="username" type="text" required /><br /><br />

    <label for="email">Email</label><br />
    <input id="email" name="email" type="email" required /><br /><br />

    <label for="full_name">Full Name</label><br />
    <input id="full_name" name="full_name" type="text" required /><br /><br />

    <label for="password">Password</label><br />
    <input id="password" name="password" type="password" required /><br /><br />

    <label for="manager_id">Manager</label><br />
    <select id="manager_id" name="manager_id">
      <option value="">No manager</option>
      {% for manager in managers %}
      <option value="{{ manager.id }}">{{ manager.full_name }} ({{ manager.username }})</option>
      {% endfor %}
    </select><br /><br />

    <label>
      <input type="checkbox" name="active" checked /> Active
    </label><br /><br />

    <button type="submit">Create User</button>
  </form>

  <h2>Existing Users</h2>
  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Username</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Active</th>
        <th>Manager</th>
        <th>Roles</th>
        <th>Assign Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.username }}</td>
        <td>{{ user.full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ "Yes" if user.active else "No" }}</td>
        <td>
          <form method="post" action="/users/{{ user.id }}/manager">
            <select name="manager_id">
              <option value="" {% if not user.manager_id %}selected{% endif %}>No manager</option>
              {% for manager in managers %}
              <option value="{{ manager.id }}" {% if user.manager_id == manager.id %}selected{% endif %}>
                {{ manager.full_name }} ({{ manager.username }})
              </option>
              {% endfor %}
            </select>
            <button type="submit">Save</button>
          </form>
        </td>
        <td>
          {% set assigned = user_roles.get(user.id, []) %}
          {% if assigned %}
            {% for role_name in assigned %}
            <div style="margin-bottom:4px;">
              <code>{{ role_name }}</code>
              <form method="post" action="/users/{{ user.id }}/roles/{{ role_name }}/remove" style="display:inline;">
                <button type="submit">Remove</button>
              </form>
            </div>
            {% endfor %}
          {% else %}
            <span>No roles</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="/users/{{ user.id }}/roles">
            <select name="role_name" required>
              {% for role in roles %}
              <option value="{{ role.name }}">{{ role.name }}</option>
              {% endfor %}
            </select>
            <button type="submit">Assign</button>
          </form>
        </td>
        <td>
          <form method="post" action="/users/{{ user.id }}/delete" onsubmit="return confirm('Delete user {{ user.username }}?')">
            <button type="submit">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
